# gRPC-Go æºç åˆ†ææŒ‡å—

## ğŸ¯ åˆ†æç›®æ ‡
é€šè¿‡æ·±å…¥åˆ†æ gRPC-Go æºç ï¼Œç†è§£å…¶æ¶æ„è®¾è®¡ã€æ ¸å¿ƒæœºåˆ¶å’Œå®ç°åŸç†ã€‚

## ğŸ“‹ åˆ†æå‡†å¤‡

### ç¯å¢ƒå‡†å¤‡
```bash
# å…‹éš†æºç 
git clone https://github.com/grpc/grpc-go.git
cd grpc-go

# å®‰è£…ä¾èµ–
go mod download

# è¿è¡Œæµ‹è¯•ç¡®ä¿ç¯å¢ƒæ­£å¸¸
go test ./...
```

### å·¥å…·å‡†å¤‡
- **IDE**: GoLand æˆ– VSCode with Go æ’ä»¶
- **è°ƒè¯•å·¥å…·**: Delve (`go install github.com/go-delve/delve/cmd/dlv@latest`)
- **ä»£ç åˆ†æ**: `go tool trace`, `pprof`
- **ç½‘ç»œåˆ†æ**: Wireshark, tcpdump

## ğŸ” æ ¸å¿ƒæ–‡ä»¶åˆ†æè·¯å¾„

### 1. å…¥å£ç‚¹åˆ†æ

#### 1.1 æœåŠ¡ç«¯å…¥å£
**æ–‡ä»¶**: `server.go`

**å…³é”®å‡½æ•°**:
```go
// åˆ›å»ºæœåŠ¡ç«¯
func NewServer(opt ...ServerOption) *Server

// æ³¨å†ŒæœåŠ¡
func (s *Server) RegisterService(sd *ServiceDesc, ss any)

// å¯åŠ¨æœåŠ¡
func (s *Server) Serve(lis net.Listener) error
```

**åˆ†æé‡ç‚¹**:
1. `Server` ç»“æ„ä½“å­—æ®µå«ä¹‰
2. æœåŠ¡æ³¨å†Œæœºåˆ¶
3. è¿æ¥ç®¡ç†ç­–ç•¥
4. è¯·æ±‚å¤„ç†æµç¨‹

#### 1.2 å®¢æˆ·ç«¯å…¥å£
**æ–‡ä»¶**: `clientconn.go`

**å…³é”®å‡½æ•°**:
```go
// åˆ›å»ºå®¢æˆ·ç«¯è¿æ¥
func NewClient(target string, opts ...DialOption) (conn *ClientConn, err error)

// å»ºç«‹è¿æ¥
func Dial(target string, opts ...DialOption) (*ClientConn, error)
```

**åˆ†æé‡ç‚¹**:
1. `ClientConn` ç»“æ„ä½“è®¾è®¡
2. è¿æ¥å»ºç«‹æµç¨‹
3. è´Ÿè½½å‡è¡¡å™¨é›†æˆ
4. æ‹¦æˆªå™¨é“¾æ„å»º

### 2. æ ¸å¿ƒæ¶æ„åˆ†æ

#### 2.1 æœåŠ¡ç«¯æ¶æ„
**æ ¸å¿ƒç»„ä»¶**:
```go
type Server struct {
    opts serverOptions          // æœåŠ¡é…ç½®é€‰é¡¹
    mu   sync.Mutex             // ä¿æŠ¤å¹¶å‘è®¿é—®
    lis  map[net.Listener]bool  // ç›‘å¬å™¨ç®¡ç†
    conns map[string]map[transport.ServerTransport]bool  // è¿æ¥ç®¡ç†
    services map[string]*serviceInfo  // æœåŠ¡æ³¨å†Œè¡¨
    events traceEventLog        // äº‹ä»¶æ—¥å¿—
    quit *grpcsync.Event        // é€€å‡ºä¿¡å·
    done *grpcsync.Event        // å®Œæˆä¿¡å·
}
```

**åˆ†æè¦ç‚¹**:
1. **å¹¶å‘æ§åˆ¶**: ç†è§£ `mu` çš„ä½œç”¨å’Œé”çš„ç²’åº¦
2. **è¿æ¥ç®¡ç†**: åˆ†æ `conns` çš„æ•°æ®ç»“æ„å’Œç”Ÿå‘½å‘¨æœŸ
3. **æœåŠ¡æ³¨å†Œ**: ç†è§£ `services` çš„æ³¨å†Œå’ŒæŸ¥æ‰¾æœºåˆ¶
4. **äº‹ä»¶å¤„ç†**: åˆ†æ `events` çš„ç”¨é€”å’Œå®ç°

#### 2.2 å®¢æˆ·ç«¯æ¶æ„
**æ ¸å¿ƒç»„ä»¶**:
```go
type ClientConn struct {
    ctx    context.Context      // ä¸Šä¸‹æ–‡
    target string               // ç›®æ ‡åœ°å€
    conns  map[*addrConn]struct{}  // è¿æ¥æ± 
    dopts  dialOptions          // è¿æ¥é€‰é¡¹
    csMgr  *connectivityStateManager  // è¿æ¥çŠ¶æ€ç®¡ç†
    pickerWrapper *pickerWrapper  // è´Ÿè½½å‡è¡¡å™¨åŒ…è£…
}
```

**åˆ†æè¦ç‚¹**:
1. **è¿æ¥æ± ç®¡ç†**: ç†è§£ `conns` çš„è¿æ¥å¤ç”¨æœºåˆ¶
2. **çŠ¶æ€ç®¡ç†**: åˆ†æ `csMgr` çš„çŠ¶æ€è½¬æ¢é€»è¾‘
3. **è´Ÿè½½å‡è¡¡**: ç†è§£ `pickerWrapper` çš„é€‰æ‹©ç­–ç•¥
4. **é…ç½®ç®¡ç†**: åˆ†æ `dopts` çš„é€‰é¡¹ä¼ é€’æœºåˆ¶

### 3. æµå¼é€šä¿¡åˆ†æ

#### 3.1 æµæ¥å£è®¾è®¡
**æ–‡ä»¶**: `stream_interfaces.go`

**æ ¸å¿ƒæ¥å£**:
```go
// æœåŠ¡ç«¯æµæ¥å£
type ServerStreamingClient[Res any] interface {
    Recv() (*Res, error)
    ClientStream
}

// å®¢æˆ·ç«¯æµæ¥å£
type ClientStreamingClient[Req any, Res any] interface {
    Send(*Req) error
    CloseAndRecv() (*Res, error)
    ClientStream
}

// åŒå‘æµæ¥å£
type BidiStreamingClient[Req any, Res any] interface {
    Send(*Req) error
    Recv() (*Res, error)
    ClientStream
}
```

**åˆ†æè¦ç‚¹**:
1. **æ³›å‹è®¾è®¡**: ç†è§£ Go æ³›å‹åœ¨æµæ¥å£ä¸­çš„åº”ç”¨
2. **æ¥å£ç»„åˆ**: åˆ†æ `ClientStream` å’Œ `ServerStream` çš„åµŒå…¥
3. **æ–¹æ³•è®¾è®¡**: ç†è§£ä¸åŒæµæ¨¡å¼çš„æ–¹æ³•å·®å¼‚

#### 3.2 æµå®ç°æœºåˆ¶
**æ–‡ä»¶**: `stream.go`

**æ ¸å¿ƒç»“æ„**:
```go
type Stream struct {
    id           uint32         // æµID
    ctx          context.Context // ä¸Šä¸‹æ–‡
    method       string         // æ–¹æ³•å
    recvCompress string         // æ¥æ”¶å‹ç¼©
    sendCompress string         // å‘é€å‹ç¼©
    buf          *recvBuffer    // æ¥æ”¶ç¼“å†²åŒº
    trReader     *transportReader // ä¼ è¾“è¯»å–å™¨
    fc           *inFlow        // å…¥æµæ§åˆ¶
    wq           *writeQuota    // å†™é…é¢
    state        streamState    // æµçŠ¶æ€
}
```

**åˆ†æè¦ç‚¹**:
1. **æµçŠ¶æ€ç®¡ç†**: ç†è§£ `state` çš„çŠ¶æ€è½¬æ¢
2. **ç¼“å†²åŒºè®¾è®¡**: åˆ†æ `buf` çš„å®ç°å’Œæ€§èƒ½ä¼˜åŒ–
3. **æµæ§åˆ¶**: ç†è§£ `fc` å’Œ `wq` çš„æµé‡æ§åˆ¶æœºåˆ¶
4. **å¹¶å‘å®‰å…¨**: åˆ†ææµæ“ä½œçš„å¹¶å‘å®‰å…¨æ€§

### 4. ä¼ è¾“å±‚åˆ†æ

#### 4.1 HTTP/2 å®ç°
**æ–‡ä»¶**: `internal/transport/http2_client.go`, `internal/transport/http2_server.go`

**æ ¸å¿ƒç»„ä»¶**:
```go
// å®¢æˆ·ç«¯ä¼ è¾“
type http2Client struct {
    ctx        context.Context
    conn       net.Conn
    goAway     chan struct{}
    framer     *framer
    controlBuf *controlBuffer
    // ...
}

// æœåŠ¡ç«¯ä¼ è¾“
type http2Server struct {
    ctx        context.Context
    conn       net.Conn
    framer     *framer
    controlBuf *controlBuffer
    // ...
}
```

**åˆ†æè¦ç‚¹**:
1. **å¸§å¤„ç†**: ç†è§£ HTTP/2 å¸§çš„è§£æå’Œæ„é€ 
2. **æµæ§åˆ¶**: åˆ†æçª—å£æ›´æ–°å’Œæµé‡æ§åˆ¶
3. **è¿æ¥ç®¡ç†**: ç†è§£è¿æ¥çš„å»ºç«‹ã€ç»´æŠ¤å’Œå…³é—­
4. **é”™è¯¯å¤„ç†**: åˆ†æå„ç§é”™è¯¯æƒ…å†µçš„å¤„ç†ç­–ç•¥

#### 4.2 æ§åˆ¶ç¼“å†²åŒº
**æ–‡ä»¶**: `internal/transport/controlbuf.go`

**æ ¸å¿ƒç»“æ„**:
```go
type controlBuffer struct {
    ch              chan struct{}
    done            <-chan struct{}
    mu              sync.Mutex
    consumerWaiting bool
    list            *itemList
    err             error
}
```

**åˆ†æè¦ç‚¹**:
1. **ç¼“å†²åŒºè®¾è®¡**: ç†è§£æ— ç•Œç¼“å†²åŒºçš„å®ç°
2. **ç”Ÿäº§è€…æ¶ˆè´¹è€…**: åˆ†æå¼‚æ­¥å¤„ç†æœºåˆ¶
3. **å†…å­˜ç®¡ç†**: ç†è§£å†…å­˜åˆ†é…å’Œå›æ”¶ç­–ç•¥
4. **æ€§èƒ½ä¼˜åŒ–**: åˆ†æå‡å°‘é”ç«äº‰çš„æŠ€æœ¯

### 5. è´Ÿè½½å‡è¡¡åˆ†æ

#### 5.1 è´Ÿè½½å‡è¡¡å™¨æ¥å£
**æ–‡ä»¶**: `balancer/balancer.go`

**æ ¸å¿ƒæ¥å£**:
```go
type Balancer interface {
    UpdateClientConnState(ClientConnState) error
    ResolverError(error)
    UpdateSubConnState(SubConn, SubConnState)
    Close()
    ExitIdle()
}

type Picker interface {
    Pick(info PickInfo) (PickResult, error)
}
```

**åˆ†æè¦ç‚¹**:
1. **æ¥å£è®¾è®¡**: ç†è§£è´Ÿè½½å‡è¡¡å™¨çš„æŠ½è±¡è®¾è®¡
2. **çŠ¶æ€ç®¡ç†**: åˆ†æè¿æ¥çŠ¶æ€çš„æ›´æ–°æœºåˆ¶
3. **é€‰æ‹©ç­–ç•¥**: ç†è§£ä¸åŒè´Ÿè½½å‡è¡¡ç®—æ³•çš„å®ç°
4. **æ‰©å±•æ€§**: åˆ†æè‡ªå®šä¹‰è´Ÿè½½å‡è¡¡å™¨çš„å®ç°æ–¹å¼

#### 5.2 å†…ç½®è´Ÿè½½å‡è¡¡å™¨
**ç›®å½•**: `balancer/`

**åˆ†æé‡ç‚¹**:
1. **pickfirst**: æœ€ç®€å•çš„é€‰æ‹©ç­–ç•¥
2. **roundrobin**: è½®è¯¢ç®—æ³•çš„å®ç°
3. **leastrequest**: æœ€å°‘è¯·æ±‚ç®—æ³•çš„å®ç°
4. **ringhash**: ä¸€è‡´æ€§å“ˆå¸Œçš„å®ç°

### 6. æ‹¦æˆªå™¨åˆ†æ

#### 6.1 æ‹¦æˆªå™¨æ¥å£
**æ–‡ä»¶**: `interceptor.go`

**æ ¸å¿ƒæ¥å£**:
```go
// å®¢æˆ·ç«¯æ‹¦æˆªå™¨
type UnaryClientInterceptor func(ctx context.Context, method string, req, reply any, cc *ClientConn, invoker UnaryInvoker, opts ...CallOption) error

// æœåŠ¡ç«¯æ‹¦æˆªå™¨
type UnaryServerInterceptor func(ctx context.Context, req any, info *UnaryServerInfo, handler UnaryHandler) (resp any, err error)
```

**åˆ†æè¦ç‚¹**:
1. **å‡½æ•°å¼è®¾è®¡**: ç†è§£å‡½æ•°å¼ç¼–ç¨‹åœ¨æ‹¦æˆªå™¨ä¸­çš„åº”ç”¨
2. **é“¾å¼è°ƒç”¨**: åˆ†ææ‹¦æˆªå™¨é“¾çš„æ„å»ºå’Œæ‰§è¡Œ
3. **ä¸Šä¸‹æ–‡ä¼ é€’**: ç†è§£ä¸Šä¸‹æ–‡åœ¨æ‹¦æˆªå™¨ä¸­çš„ä½œç”¨
4. **é”™è¯¯å¤„ç†**: åˆ†ææ‹¦æˆªå™¨ä¸­çš„é”™è¯¯ä¼ æ’­æœºåˆ¶

#### 6.2 æ‹¦æˆªå™¨é“¾å®ç°
**åˆ†æé‡ç‚¹**:
1. **é“¾æ„å»º**: ç†è§£å¤šä¸ªæ‹¦æˆªå™¨çš„ç»„åˆæ–¹å¼
2. **æ‰§è¡Œé¡ºåº**: åˆ†ææ‹¦æˆªå™¨çš„æ‰§è¡Œé¡ºåº
3. **æ€§èƒ½å½±å“**: ç†è§£æ‹¦æˆªå™¨å¯¹æ€§èƒ½çš„å½±å“
4. **æœ€ä½³å®è·µ**: åˆ†ææ‹¦æˆªå™¨çš„ä½¿ç”¨å»ºè®®

### 7. æ€§èƒ½ä¼˜åŒ–åˆ†æ

#### 7.1 å†…å­˜ç®¡ç†
**æ–‡ä»¶**: `mem/`

**åˆ†æé‡ç‚¹**:
1. **ç¼“å†²åŒºæ± **: ç†è§£å†…å­˜æ± çš„è®¾è®¡å’Œå®ç°
2. **å¯¹è±¡å¤ç”¨**: åˆ†æå¯¹è±¡å¤ç”¨çš„ç­–ç•¥
3. **GC ä¼˜åŒ–**: ç†è§£å‡å°‘ GC å‹åŠ›çš„æŠ€æœ¯
4. **å†…å­˜æ³„æ¼**: åˆ†æå†…å­˜æ³„æ¼çš„é¢„é˜²æªæ–½

#### 7.2 å¹¶å‘ä¼˜åŒ–
**åˆ†æé‡ç‚¹**:
1. **goroutine ç®¡ç†**: ç†è§£ goroutine çš„åˆ›å»ºå’Œé”€æ¯
2. **é”ä¼˜åŒ–**: åˆ†æé”çš„ç²’åº¦å’Œç«äº‰å‡å°‘
3. **channel ä½¿ç”¨**: ç†è§£ channel åœ¨å¹¶å‘ä¸­çš„ä½œç”¨
4. **æ€§èƒ½ç›‘æ§**: åˆ†ææ€§èƒ½ç›‘æ§çš„å®ç°

## ğŸ”§ è°ƒè¯•æŠ€å·§

### 1. ä½¿ç”¨ Delve è°ƒè¯•
```bash
# è°ƒè¯•æœåŠ¡ç«¯
dlv debug examples/helloworld/greeter_server/main.go

# è°ƒè¯•å®¢æˆ·ç«¯
dlv debug examples/helloworld/greeter_client/main.go
```

### 2. ä½¿ç”¨ pprof åˆ†ææ€§èƒ½
```go
import _ "net/http/pprof"

// åœ¨æœåŠ¡ç«¯æ·»åŠ 
go func() {
    log.Println(http.ListenAndServe("localhost:6060", nil))
}()
```

### 3. ä½¿ç”¨ trace åˆ†æå¹¶å‘
```go
import "runtime/trace"

f, err := os.Create("trace.out")
if err != nil {
    log.Fatal(err)
}
defer f.Close()
err = trace.Start(f)
if err != nil {
    log.Fatal(err)
}
defer trace.Stop()
```

## ğŸ“Š æ€§èƒ½åˆ†ææŒ‡æ ‡

### 1. å…³é”®æŒ‡æ ‡
- **å»¶è¿Ÿ**: RPC è°ƒç”¨çš„å“åº”æ—¶é—´
- **ååé‡**: æ¯ç§’å¤„ç†çš„è¯·æ±‚æ•°
- **å¹¶å‘æ•°**: åŒæ—¶å¤„ç†çš„è¯·æ±‚æ•°
- **å†…å­˜ä½¿ç”¨**: å†…å­˜åˆ†é…å’Œ GC æƒ…å†µ

### 2. ç›‘æ§ç‚¹
- è¿æ¥å»ºç«‹æ—¶é—´
- è¯·æ±‚å¤„ç†æ—¶é—´
- æµæ§åˆ¶æ•ˆæœ
- è´Ÿè½½å‡è¡¡æ•ˆæœ

## ğŸ¯ å­¦ä¹ å»ºè®®

### 1. å¾ªåºæ¸è¿›
1. å…ˆç†è§£åŸºæœ¬æ¦‚å¿µå’Œ API ä½¿ç”¨
2. å†æ·±å…¥æ ¸å¿ƒå®ç°å’Œæ¶æ„è®¾è®¡
3. æœ€åå…³æ³¨æ€§èƒ½ä¼˜åŒ–å’Œæœ€ä½³å®è·µ

### 2. å®è·µç»“åˆ
1. è¾¹è¯»æºç è¾¹å†™æµ‹è¯•ä»£ç 
2. å°è¯•ä¿®æ”¹å’Œæ‰©å±•åŠŸèƒ½
3. å¯¹æ¯”ä¸åŒç‰ˆæœ¬çš„å®ç°å·®å¼‚

### 3. å·¥å…·è¾…åŠ©
1. ä½¿ç”¨ IDE çš„ä»£ç å¯¼èˆªåŠŸèƒ½
2. åˆ©ç”¨è°ƒè¯•å·¥å…·è·Ÿè¸ªæ‰§è¡Œæµç¨‹
3. ä½¿ç”¨æ€§èƒ½åˆ†æå·¥å…·ä¼˜åŒ–ä»£ç 

é€šè¿‡ç³»ç»Ÿæ€§çš„æºç åˆ†æï¼Œæ‚¨å°†å»ºç«‹èµ·å¯¹ gRPC-Go çš„æ·±åˆ»ç†è§£ï¼Œå¹¶èƒ½å¤Ÿåº”ç”¨åˆ°å®é™…çš„é¡¹ç›®å¼€å‘ä¸­ï¼ 